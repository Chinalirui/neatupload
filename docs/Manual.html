<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>

  
  <title>NeatUpload Manual</title>
</head>


<body>


<h1>NeatUpload Manual</h1>


<ul id="mozToc">


<!--mozToc h2 1 h3 2 h4 3 h5 4 h5 5 h6 6--><li><a href="#mozTocId903858">Introduction</a></li>


  <li><a href="#mozTocId304923">Installation</a></li>


  <li><a href="#mozTocId50790">Basic Usage</a></li>


  <li><a href="#mozTocId875291">Advanced Usage</a>
    
    <ul>


      <li><a href="#mozTocId905959">Changing the
Temporary Directory</a></li>


      <li><a href="#mozTocId329006">Limiting the
Size of Upload Requests</a></li>


      <li><a href="#mozTocId358727">Changing the
Maximum Size of Normal Requests</a></li>


      <li><a href="#mozTocId390633">Customizing
Progress.aspx</a></li>


      <li><a href="#mozTocId184279">Creating Custom
Fallback Content for ProgressBar</a></li>


    
    </ul>


  </li>


  <li><a href="#mozTocId580088">Known Issues</a>
    
    <ul>


      <li><a href="#mozTocId766780">HttpResponse.AppendToLog()
does nothing when UploadHttpModule is used</a></li>


    
    </ul>


  </li>


  <li><a href="#mozTocId405545">Troubleshooting</a></li>


</ul>


<h2><a class="mozTocH2" name="mozTocId903858"></a>Introduction</h2>


<p> <a href="http://www.brettle.com/neatupload">NeatUpload</a>
allows <a href="http://en.wikipedia.org/wiki/ASP.NET">ASP.NET</a>
developers to stream uploaded files to disk and allows users to monitor
upload progress. It is <a href="http://opensource.org/docs/definition.php">open source</a>
and works under <a href="http://www.mono-project.com/">Mono's</a>
<a href="http://www.go-mono.com/asp-net.html#xsp">XSP</a>
/ <a href="http://www.go-mono.com/asp-net.html#mod_mono">mod_mono</a>
as well as Microsoft's ASP.NET implementation. </p>


<p> NeatUpload contains two custom controls (<code>InputFile</code>
and <code>ProgressBar</code>), an <code>HttpModule</code>
(<code>UploadHttpModule</code>), and a page (<code>Progress.aspx</code>).
This section briefly describes what they each do and how they are
related. The remainder of this manual describes how to install and use
NeatUpload. </p>


<p> <code><strong>InputFile</strong></code>
is a custom control that renders like <code>HtmlInputFile</code>,
but provides properties to access the temporary file containing the
upload, as well as the client-specified name and content type. </p>


<p> <code><strong>ProgressBar</strong></code>
is a custom control that is responsible for providing a site for the
progress to be displayed. It provides an attribute to control whether
to display the progress inline or in a popup. It also provides an <code>AddTrigger()</code>
method to specify which which buttons should trigger the progress
display to start refreshing. If the progress is displayed inline, the <code>ProgressBar</code>
control renders as an IFRAME. Otherwise, it renders as a DIV containing
a "Check Upload Progress" link (to display the progress in a new
window) along with some JavaScript which removes the DIV when the page
loads. This provides a fallback when JavaScript is not available. Note
that <code>ProgressBar</code> doesn't actually display the
progress bar itself. It merely provides a site (an IFRAME or popup)
which loads the <code>Progress.aspx</code> page. <code>Progress.aspx</code>
(described below) displays the progress bar. </p>


<p> <code><strong>UploadHttpModule</strong></code>
is an <code>HttpModule</code> that intercepts each
request, streams <code>InputFile</code> uploads to
temporary files, and restricts the size of the remainder of the
request. Since <code>UploadHttpModule</code> touches every
request, a bug in it could affect pages that don't even contain <code>InputFile</code>
controls. For this reason, you can remove <code>UploadHttpModule</code>
from the <code>Web.config</code> while continuing to use <code>InputFile</code>
and <code>ProgressBar</code>. If you do that, NeatUpload
will get the uploaded file from the ASP.NET standard <code>HttpRequest.Files</code>
property instead of intercepting the request. That means that <code>InputFile</code>
will function like an <code>HtmlInputFile</code> control,
but no progress bar will be displayed. This greatly reduces the risk of
adopting NeatUpload. </p>


<p> <code><strong>Progress.aspx</strong></code>
is the page that is displayed in the site provided by the <code>ProgressBar</code>
control (i.e. in the IFRAME or popup). The codebehind for <code>Progress.aspx</code>
is compiled into the NeatUpload assembly. That code retrieves
the&nbsp;status of the upload from the <code>UploadHttpModule</code>,
modifies the HTML generated by Progress.aspx (e.g. the width of the
progress bar itself), and inserts JavaScript which causes the display
to update. </p>


<h2><a class="mozTocH2" name="mozTocId304923"></a>Installation</h2>


<p> Installing NeatUpload is pretty straightforward. Just copy
the necessary assemblies and subdirectories into your application and
make some
modification to your <code>Web.config</code>.
Specifically: </p>


<ol>


  <li>If you haven't already, download the release and extract
it wherever you want. All the files will be extracted into a
subdirectory name <code>NeatUpload-1.0/</code>. </li>


  <li>(Optional) To see the demo running on your local machine,
configure IIS, mod_mono, or XSP so that <code>NeatUpload-1.0/</code>
is a web application. Then point your browser at the <code>Demo.aspx</code>
on that
website. To use NeatUpload in your own web application, continue with
the remaining installation steps. </li>


  <li>NeatUpload requires&nbsp;<a href="http://logging.apache.org/log4net/">log4net</a> which can be configured to log useful debugging information. &nbsp;If you aren't already using log4net:
    
    <ol>


      <li>Copy the log4net.dll from the <code>NeatUpload-1.0/bin/Debug/</code>
or <code>NeatUpload-1.0/bin/Release/</code> directory to
the <code>bin/ </code>directory of your web application.</li>


      <li>Add a reference to your web application that refers to
the copy of <code>log4net.dll</code> in your <code>bin/</code>
directory.</li>


      <li>Copy <code>NeatUpload-1.0/log4net.config</code>
to the root directory of your web application. &nbsp;With that configuration log4net will not actually log anything. </li>


      <li>Add the following line to the top of your <code>Global.asax.cs</code>:
        <br>

        <br>

        <code>[assembly: log4net.Config.XmlConfigurator(ConfigFile="log4net.config", Watch=true)]</code><br>

        <br>

or if you are using VB.NET, add the following to the top of your Global.asax.vb:<br>

        <code><br>

&lt;assembly: log4net.Config.XmlConfigurator(ConfigFile:="log4net.config", Watch:=true)&gt;</code>	</li>


    
    </ol>


  </li>


  <li>Copy <code>Brettle.Web.NeatUpload.dll</code>
from the <code>NeatUpload-1.0/bin/Debug/</code>
or <code>NeatUpload-1.0/bin/Release/</code> directory to
the <code>bin/</code>
directory of your web application.</li>


  <li>Add a reference to your application that refers to the copy
of <code>Brettle.Web.NeatUpload.dll</code> in your <code>bin/</code>
directory.</li>


  <li>Create a <code>NeatUpload/</code>
subdirectory in
your web application by copying <code>NeatUpload-1.0/NeatUpload/</code>.
&nbsp;That subdirectory contains <code>Progress.aspx</code>
and associated files. &nbsp;Note: If you add <code>Progress.aspx</code>
to your VS.NET project it will say, "There
is no class file in the project associated with the Web Form
'Progress.aspx'.&nbsp; Create a new class file now?".
&nbsp;Answer "No"
because the class file is compiled into&nbsp;<code>Brettle.Web.NeatUpload.dll</code>.
  </li>


  <li>Add the following line to your <code>Web.config</code>
under <code>configuration/system.web/httpModules</code>:
    
    <pre>&lt;add name="UploadHttpModule" type="Brettle.Web.NeatUpload.UploadHttpModule, Brettle.Web.NeatUpload" /&gt;<br>	</pre>


  </li>


  <li>(Optional) To allow larger uploads than the default of 4
Mbytes, you <span style="font-style: italic;">might</span>
need to add or modify the following line in your <code>Web.config</code>
under <code>configuration/system.web</code>:
    
    <pre>&lt;httpRuntime maxRequestLength="<var>size_in_kbytes</var>" /&gt;&nbsp;<br></pre>


At the moment, both .NET and Mono seem to ignore that setting when
NeatUpload is being used, but there is no official documentation
specifying exactly when that limit is enforced, so a future version of
.NET or Mono might enforce the limit even when NeatUpload is being
used. &nbsp; Setting the <code>&lt;httpRuntime&gt;</code>
element's <code>maxRequestLength</code>
attribute simply provides insurance against such future changes.
&nbsp;Note that since that attribute is currently ignored when
NeatUpload is used, you can't use it to actually restrict the size of
uploads. &nbsp;To do that, see <a href="#Limiting_the_Size_of_Upload_Requests">Limiting the
Size of Upload Requests</a> below.<br>


  </li>


  <li>(Optional) Copy <code>Demo.aspx</code> from <code>NeatUpload-1.0/</code>
into your application. Point your browser at <code>Demo.aspx</code>
and verify that the demo functions properly. </li>


</ol>


<p> That's it. Now you're ready to start using NeatUpload. Keep
reading for details. </p>


<h2><a class="mozTocH2" name="mozTocId50790"></a>Basic
Usage</h2>


<p> To use NeatUpload on an ASP.NET page, follow these steps: </p>


<ol>


  <li>Add the following to the top of your page:
    
    <pre> <br>&lt;%@ Register TagPrefix="Upload" Namespace="Brettle.Web.NeatUpload" Assembly="Brettle.Web.NeatUpload" %&gt;<br>	</pre>


  </li>


  <li>Add an <code>InputFile</code> control to your
aspx page wherever you
want the user to choose a file, using something like this:
    
    <pre>&lt;Upload:InputFile id="<var>inputFileId</var>" runat="server" /&gt;<br>	</pre>


Feel free to add any attributes that you would normally add to an <code>HtmlInputFile</code>
tag. </li>


  <li>Add a <code>ProgressBar</code> control to
your aspx page wherever you
want to display an inline progress bar or, in the case of a popup
progress bar, add it wherever you want the fallback link to be
displayed. &nbsp;Use something like this:
    
    <pre>&lt;Upload:ProgressBar id="<var>progressBarId</var>" runat="server" inline="<var>true|false</var>" /&gt;<br>	</pre>


The inline attribute defaults to false. </li>


  <li>Add a submit button to your aspx page, using a
submit button control that renders as <code>&lt;input
type="submit" ...&gt;</code>. For example:
    
    <pre>&lt;asp:Button id="<var>submitButtonId</var>" runat="server" Text="<var>Submit</var>" /&gt;<br></pre>


    <span style="font-weight: bold;">Note</span>: <code>&lt;asp:LinkButton&gt;</code>
renders as <code>&lt;a
href="..."&gt;...&lt;/a&gt;</code> and is not
supported by NeatUpload-1.0.x. &nbsp;Support for <code>LinkButtons</code>
might be added in NeatUpload-1.1.x or later.</li>


  <li> In your codebehind file, declare each <code>InputFile</code>
and <code>ProgressBar</code> control using code like this:
    
    <pre>using Brettle.Web.NeatUpload;<br>...<br>	public class YourPage : System.Web.UI.Page<br>	{<br>	...<br>	protected InputFile <var>inputFileId</var>;<br>	protected ProgressBar <var>progressBarId</var>;<br>	</pre>


  </li>


  <li>In your <code>Page_Load</code> method (or
anywhere that gets executed
before the page is rendered), add the submit button as a trigger for
your progress bar:
    
    <pre>	private void Page_Load(object sender, EventArgs e)<br>	{<br>	...<br>	<var>	progressBarId</var>.AddTrigger(<var>submitButtonId</var>);<br><br>	</pre>


  </li>


  <li>In your codebehind file,&nbsp;process the
uploaded
file during the <span style="font-family: monospace;"></span><code>PreRender</code>
phase. &nbsp;The file itself can be accessed via <code><var>inputFileId</var>.TmpFile</code>.
The <code>TmpFile </code>property is a <code>FileInfo</code>
object, so you can use its <code>MoveTo()</code> method to
move the uploaded file to a permanent location. The client-specified
name and content type of the uploaded file can be accessed via <code><var>inputFileId</var>.FileName</code>
and <code><var>inputFileId</var>.ContentType</code>.
&nbsp;All three properties will be <code>null</code>
if no file was uploaded. &nbsp;So something like the following will
put the uploaded file in the
application's root directory if it doesn't already exist (assuming
sufficient permissions):
    
    <pre>using System.IO;<br>...<br>	private void Page_PreRender(object sender, EventArgs e)<br>	{<br>	...<br>	if (IsPostBack &amp;&amp; <var>inputFileId</var>.TmpFile != null)<br>	{<br>	...<br>	<var>	inputFileId</var>.TmpFile.MoveTo(Path.Combine(Request.PhysicalApplicationPath,&nbsp;<br>	Path.GetFileName(<var>inputFileId</var>.FileName)));<br><br></pre>


  </li>


</ol>


<h2><a class="mozTocH2" name="mozTocId875291"></a>Advanced
Usage</h2>


<h3><a class="mozTocH3" name="mozTocId905959"></a>Changing
the Temporary Directory</h3>


<p> By default, NeatUpload puts uploaded files in temporary files
in the <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpref/html/frlrfsystemiopathclassgettemppathtopic.asp">system's
temporary directory</a>. You can specify a different directory by
adding a line like this to your <code>Web.config</code>
under <code><tt>configuration/appSettings</tt></code>:
</p>


<pre>	&lt;add key="NeatUpload.DefaultTempDirectory" value="<var>yourTempDir</var>" /&gt;<br>	</pre>


If the directory you specify is relative, it will be relative to your
application root directory.
<h3><a class="mozTocH3" name="Limiting_the_Size_of_Upload_Requests"></a>Limiting
the Size of Upload Requests</h3>


<p>By default, NeatUpload does not directly limit the size of
uploads.
&nbsp;To limit upload size&nbsp;add a line like this to your <code>Web.config</code>
under
<code>configuration/appSettings</code>: </p>


<pre>	&lt;add key="NeatUpload.MaxRequestLength" value="<em>sizeInKBytes</em>" /&gt;<br></pre>


<p>If a user attempts to upload a file larger than the specified
size, NeatUpload will call:</p>


<pre>	throw HttpException(413,&nbsp;"Request Entity Too Large")</pre>


<p>By
default, this will cause the browser to display an generic error page. &nbsp;If you want something
more
user-friendly, you can either handle the error by adding a handler for
the <code>HttpApplication.Error</code> event, or you can
use a custom
error page.</p>
<p>Note: most browsers, including IE and Firefox, won't display
anything until the entire upload has been sent to the server. &nbsp;If
that takes longer than the amount of time specified via the <code>httpRuntime</code> element's <code>executionTimeout</code>
attribute, the server may choose to close the connection and the user
will see a different error. &nbsp;IE will display a generic error page
saying "Page cannot be displayed". &nbsp;Firefox will display a dialog
saying "Document contains no data". &nbsp;The default <code>executionTimeout</code> is 360 seconds.</p>


<h3><a class="mozTocH3" name="mozTocId358727"></a>Changing
the Maximum Size of Normal Requests</h3>


<p>By default, NeatUpload
restricts the size of
non-upload requests and the non-upload portion of upload requests to 4
MBytes. To specify a different maximum
size, add a line like this to your <code>Web.config</code>
under
<code>configuration/appSettings</code>: </p>


<pre>	&lt;add key="NeatUpload.MaxNormalRequestLength" value="<em>sizeInKBytes</em>" /&gt;<br></pre>
()ar

<h3><a class="mozTocH3" name="mozTocId390633"></a>Customizing
<code>Progress.aspx</code></h3>


<p> The <code>Progress.aspx</code> page that comes
with NeatUpload is just an
example. You can modify it to suit your needs. For example, you
could change the color scheme with minor modification to the
<code>default.css</code> stylesheet that is included, or
you could change the text
or images that are used by modifying <code>Progress.aspx</code>
itself. You could
even rearrange the layout entirely. The only restriction is that you
must continue to include elements with the following id attributes and
tag names, each with the runat attribute set to "server": </p>


<table border="1">


  <thead><tr>


    <td><strong>ID</strong></td>


    <td><strong>Tag Name</strong></td>


  </tr>


  </thead> <tbody>


    <tr>


      <td><code>barDiv</code></td>


      <td>any</td>


    </tr>


    <tr>


      <td><code>statusDiv</code></td>


      <td>any</td>


    </tr>


    <tr>


      <td><code>inProgressSpan</code></td>


      <td>any</td>


    </tr>


    <tr>


      <td><code>remainingTimeSpan</code></td>


      <td>any</td>


    </tr>


    <tr>


      <td><code>completedSpan</code></td>


      <td>any</td>


    </tr>


    <tr>


      <td><code>cancelledSpan</code></td>


      <td>any</td>


    </tr>


    <tr>


      <td><code>refreshLink</code></td>


      <td>A</td>


    </tr>


    <tr>


      <td><code>stopRefreshLink</code></td>


      <td>A</td>


    </tr>


    <tr>


      <td><code>cancelLink</code></td>


      <td>A</td>


    </tr>


  
  </tbody>
</table>


<p> Refer to the sample <code>Progress.aspx</code>
to see how each of these
elements is used. Note that the codebehind will hide the link
elements (and their contents) when appropriate. For example, the
<code>refreshLink</code> and <code>stopRefreshLink</code>
elements are hidden whenever JavaScript
is available because they are used to manually start and stop
refreshing the progress display. </p>


<h3><a class="mozTocH3" name="mozTocId184279"></a>Creating
Custom Fallback Content for <code>ProgressBar</code></h3>


<p> If JavaScript is not available or the browser doesn't support
IFRAMEs and the <code>ProgressBar</code> element is empty,
a "Check Upload Progress"
link will be displayed. To change the text of that link, simply place
the desired text (or controls) between the begin and end tags of the
<code>ProgressBar</code> element. For example: </p>


<pre>	&lt;Upload:ProgressBar id="progressBar" runat="server" &gt;<br>	&lt;asp:Label id="label" runat="server" Text="Your Text Here"/&gt;<br>	&lt;/Upload:ProgressBar&gt;<br>	</pre>


<h2><a class="mozTocH2" name="mozTocId580088"></a>Known
Issues</h2>


<h3><a class="mozTocH3" name="mozTocId766780"></a><code>HttpResponse.AppendToLog()</code>
does nothing when <code>UploadHttpModule</code> is used</h3>


<p>Due to the design of NeatUpload this bug will not be fixed,
however NeatUpload does provide a workaround. &nbsp;Simply replace <code>Response.AppendToLog()</code>
with <code>Brettle.Web.NeatUpload.UploadHttpModule.AppendToLog()</code>.
&nbsp;That will work whether the <code>UploadHttpModule</code>
is used or not.</p>
<h4>Inline <code>ProgressBars </code>don't work with Opera</h4>
<p>Opera does not seem to allow an <code>IFRAME</code> to be updated during form submission. &nbsp;Currently, the only known workaround is to use a popup <code>ProgressBar</code>.</p>
<h2><a class="mozTocH2" name="mozTocId405545"></a>Troubleshooting</h2>


<p>Whenever NeatUpload's <code>UploadHttpModule</code>
is added via the <code>&lt;httpModules&gt;</code>
section of your <code>Web.config</code>, it intercepts and
filters <span style="font-style: italic;">all</span><span style="font-weight: bold; font-style: italic;"> </span>requests
sent to your application. &nbsp;For upload requests, it streams the
uploaded files to disk and makes them available to your code via <code>InputFile</code>.
&nbsp;It also limits the size of the non-upload part of the request
<span style="font-style: italic;">and the total size of
non-upload requests</span>
because that request data is stored in server memory. &nbsp;If it
didn't do that an attacker could mount a Denial of Service attack by
sending a request that contains a large amount of non-file data.</p>


<p>If you think NeatUpload's <code>UploadHttpModule</code>
might be causing a problem, the first thing you should do is remove the
<code>UploadHttpModule</code> from your <code>Web.config</code>
and try to reproduce the problem. &nbsp;All of your existing code
should continue to work without the <code>UploadHttpModule</code>
- you just won't get progress bars and streaming of files to disk.
&nbsp;If the problem goes away when you remove the <code>UploadHttpModule</code>,
it is a bug so please <a href="http://www.brettle.com/neatupload_bugs">report it</a>.
&nbsp;You can help me diagnosis the problem by doing the following:</p>


<ol>


  <li>Add the <code>UploadHttpModule</code> back to
your <code>Web.config</code>.</li>


  <li>Increase the log level to DEBUG in log4net. &nbsp;To
that simply change <code>&lt;level value="INFO" /&gt;</code>
to <code>&lt;level value="DEBUG" /&gt;</code> in
your <code>log4net.config</code>.</li>


  <li>Reproduce the problem.</li>


  <li>Send me (dean at brettle dot com) a zip file containing the
files
from your temp directory with the extensions ".body" and ".sizes".
&nbsp;Each ".body" file contains the body of a request you sent
when
reproducing the problem. &nbsp;The corresponding ".sizes" file
contains
the MIME type of the request and the size of each chunk that NeatUpload
read. &nbsp;I can use the <code>TestFilter.exe</code>
program to reproduce how the <code>UploadHttpModule</code>
processed the request and (hopefully) determine exactly what went wrong.</li>


</ol>


<br>


</body>
</html>
