<Html>
	<Head>
		<Title>NeatUpload Manual</Title>
	</Head>
	<Body>
		<h2>Introduction</h2>
		<p>
		<a href="http://www.brettle.com/neatupload/">NeatUpload</a> allows 
		<a href="http://en.wikipedia.org/wiki/ASP.NET">ASP.NET</a> developers to stream uploaded files 
		to disk and allows users to monitor upload progress. It is 
		<a href="http://opensource.org/docs/definition.php">open
		source</a> and works under <a href="http://www.mono-project.com/">Mono's</a> 
		<a href="http://www.go-mono.com/asp-net.html#xsp">XSP</a>
		/ <a href="http://www.go-mono.com/asp-net.html#mod_mono">mod_mono</a> as well as Microsoft's ASP.NET 
		implementation.
		</p>
		<p>
		NeatUpload contains two custom controls (InputFile and ProgressBar), an HttpModule (UploadHttpModule), and 
		a page (Progress.aspx).  This section briefly describes what they each do and how they relate to one another.
		The remainder of this manual describes how to install and use NeatUpload.
		</p>
		<p>
		<strong>InputFile</strong> custom control that renders like HtmlInputFile, but provides properties to access the temporary 
		file containing the upload, as well as the client-specified name and content type.  
		</p>
		<p>
		<strong>ProgressBar</strong> is a custom control that is responsible for providing a site for the progress to be displayed.  It
		provides an attribute to control whether to display the progress inline or in a popup.  It provides an 
		AddTrigger() method to specify which which buttons should trigger the progress display to start refreshing.	If
		the	progress is displayed inline, the ProgressBar control renders as an IFRAME.  Otherwise, it renders as a DIV
		containing a &quot;Check Progress&quot; link to display the progress in a new window, along with some JavaScript
		which removes the DIV when the page loads.  This provides a fallback when JavaScript is not available.
		Note that ProgressBar doesn't actually display the progress bar itself.  It merely provides a site (an IFRAME or
		popup) which loads the Progress.aspx page.  Progress.aspx (described below) displays the progress bar.
		</p>
		<p>
		<strong>UploadHttpModule</strong> is an HttpModule that intercepts each request, streams InputFile uploads to temporary files, and
		restricts the size of remainder of the request.  Since UploadHttpModule touches every request, a bug in
		it could affect pages that don't even contain InputFile controls.  For this reason, it is possible to remove 
		UploadHttpModule from the Web.config while continuing to use InputFile and ProgressBar.  If you do that, NeatUpload
		will get the uploaded file from the ASP.NET standard HttpRequest.Files property instead of intercepting the 
		request.  That means that InputFile will function like a HtmlInputFile control, but no progress bar will be 
		displayed.  This greatly reduces the risk in adopting NeatUpload.
		</p>
		<p>
		<strong>Progress.aspx</strong> is the page that is displayed in the site provided by the ProgressBar control (ie the 
		IFRAME or popup).  The codebehind for Progress.aspx is compiled into the NeatUpload assembly.  That code
		communicates with the UploadHttpModule to determine the status of the upload, modify the HTML generated by
		Progress.aspx (eg the width of the progress bar itself), and insert the JavaScript which causes the display 
		to update.
		</p>

		<h2>Installation</h2>
		<p>
		Installing NeatUpload is pretty straightforward.  Just copy the necessary assemblies and subdirectories into
		your app and make some modification to your <tt>Web.config</tt>.  Specifically: 
		</p>
		<ol>
			<li>
			If you haven't already, download the release and extract it wherever you want.  All the files will be 
			extracted into a subdirectory name <tt>NeatUpload-1.0/</tt>.
			</li>
			<li>
			(Optional) To see the demo running on your local machine, configure IIS, mod_mono, or XSP so that 
			<tt>NeatUpload-1.0/</tt> is a web application.  Then point your browser at the Demo.aspx on that website.  
			To use NeatUpload in your own web application, continue with the remaining installation steps.
			</li>
			<li>
			If you aren't already using log4net:
				<ol>
					<li>
					Copy log4net.dll from the <tt>NeatUpload-1.0/bin/Debug/</tt> or	<tt>NeatUpload-1.0/bin/Release/</tt>
					directory to the <tt>bin/</tt> directory of your web application.
					</li>
					<li>
					Copy <tt>NeatUpload-1.0/log4net.config</tt> to the top-level directory of your web application.
					</li>
					<li>
					Add the following line to the top of your <tt>Global.asax.cs</tt>:
					<pre>
[assembly: log4net.Config.XmlConfigurator(ConfigFile=&quot;log4net.config&quot;, Watch=true)]
					</pre>
					</li>
				</ol>
			</li>
			<li>
			Copy Brettle.Web.NeatUpload.dll from the <tt>NeatUpload-1.0/bin/Debug/</tt> or
			<tt>NeatUpload-1.0/bin/Release/</tt> directory to the <tt>bin/</tt> directory of your web application.
			</li>
			<li>
			Create a <tt>NeatUpload/</tt> subdirectory in your web application by copying 
			<tt>NeatUpload-1.0/NeatUpload/</tt>.
			</li>
			<li>
			Add the following line to your <tt>Web.config</tt> under <tt>configuration/system.web/httpModules</tt>:
			<pre>
&lt;add name=&quot;UploadHttpModule&quot; type=&quot;Brettle.Web.NeatUpload.UploadHttpModule, Brettle.Web.NeatUpload&quot; /&gt;
			</pre>
			</li>
			<li>
			(Optional) To allow larger uploads than the default of 4 Mbytes, add or modify the following line in your 
			<tt>Web.config</tt>	under <tt>configuration/system.web</tt>:
			<pre>
&lt;httpRuntime maxRequestLength=&quot;SIZE_IN_KBYTES&quot; /&gt;
			</pre>
			</li>
			<li>
			(Optional) Copy <tt>Demo.aspx</tt> from <tt>NeatUpload-1.0/</tt> into your application.  Point your browser
			at <tt>Demo.aspx</tt> verify that the demo functions properly. 
			</li>
		</ol>
		<p>
		That's it.  Now you're ready to start using NeatUpload.  Keep reading for details.
		</p>

		<h2>Basic Usage</h2>
		<p>
		To use NeatUpload on an ASP.NET page, follow these steps:
		<ol>
			<li>
			Add the following to the top of your page:
			<pre> 
&lt;%@ Register TagPrefix=&quot;Upload&quot; Namespace=&quot;Brettle.Web.NeatUpload&quot; Assembly=&quot;Brettle.Web.NeatUpload&quot; %&gt;
			</pre>
			</li>
			<li>
			Add an InputFile control to your aspx page wherever you want the user to choose a file, using something like 
			this:
			<pre>
&lt;Upload:InputFile id=&quot;<em>inputFileId</em>&quot; runat=&quot;server&quot; /&gt;
			</pre>
			Feel free to add any attributes that you would normally add to an HtmlInputFile tag.
			</li>
			<li>
			Add a ProgressBar control to your aspx page wherever you want to display an inline progress bar or a 
			fallback link for a popup progress bar, using something like this:
			<pre>
&lt;Upload:ProgressBar id=&quot;<em>progressBarId</em>&quot; runat=&quot;server&quot; inline=&quot;<em>true|false</em>&quot; />
			</pre>
			The inline attribute defaults to false.
			</li>
			<li>
			Add a submit button to your aspx page, using your favorite submit button control.  For example:
			<pre>
&lt;asp:Button id=&quot;<em>submitButtonId</em>&quot; runat=&quot;server&quot; Text=&quot;Submit&quot; /&gt;
			</pre>			
			</li>
			<li>
			In your codebehind file, declare each InputFile and ProgressBar control using code like this:
			<pre>
using Brettle.Web.NeatUpload;
...
	public class YourPage : System.Web.UI.Page
	{
	...
		protected InputFile <em>inputFileId</em>;
		protected ProgressBar <em>progressBarId</em>;
			</pre>
			</li>
			<li>
			In your Page_Load method (or anywhere that gets executed before the page is rendered), add the submit
			buttons as triggers to for your progress bar:
			<pre>
		private void Page_Load(object sender, EventArgs e)
		{
		...
			<em>progressBarId</em>.AddTrigger(<em>submitButtonId</em>);
		...
		}
			</pre>
			</li>
			<li>
			In your codebehind file where you are handling postbacks (eg in the submit button click event handler), 
			process the uploaded file.  The file itself can be accessed via <tt><em>inputFileId</em>.TmpFile</tt>.
			The <tt>TmpFile</tt> property is a <tt>FileInfo</tt> object, so you can use its <em>MoveTo()</em> method
			to move the uploaded file to a permanent location.  The client-specified name and content type of the
			uploaded file can be accessed via <tt><em>inputFileId</em>.FileName</tt> and 
			<tt><em>inputFileId</em>.ContentType</tt>.  So something like the following will put the uploaded file in
			the application's root directory if it doesn't already exist (assuming sufficient permissions):
			<pre>
using System.IO;
...
		private void Page_Load(object sender, EventArgs e)
		{
		...
			if (IsPostBack)
			{
				...
				<em>inputFileId</em>.TmpFile.MoveTo(Path.Combine(Request.PhysicalApplicationPath, Path.GetFileName(<em>inputFileId</em>.FileName)));
				...
			}
		...
		}
			</pre>
			</li>
		</ol>
		</p>
		<h2>Advanced Usage</h2>
		<h3>Changing the Temp Directory</h3>
		<p>
		By default, NeatUpload puts uploaded files in temporary files in the 
		<a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpref/html/frlrfsystemiopathclassgettemppathtopic.asp">system's 
		temporary directory</a>.  You can specify a different directory by adding a line like this to your Web.config
		under <tt>configuration/appSettings</tt>:
		<pre>
		&lt;add key=&quot;NeatUpload.DefaultTempDirectory&quot; value=&quot;<em>yourTempDir</em>&quot; /&gt;
		</pre>
		If the directory you specify is relative, it will be relative to the current working directory at the time the
		upload occurs. 
		</p>
		
		<h3>Changing the Maximum Size of Normal Requests</h3>
		<p>
		When you installed NeatUpload you probably increased ASP.NET's maxRequestLength value to allow for uploads larger
		than 4 MBytes.  Of course, the maxRequestLength setting applies to all requests, not just those that contain
		uploads.  Since non-upload requests (and the non-upload portion of upload 
		requests) are stored in memory, you probably don't want to allow them to be as big as maxRequestLength.  To 
		prevent this, NeatUpload restricts the size of such requests to 4 MBytes by default.  To specify a different 
		maximum size, add a line like this to your Web.config under configuration/appSettings:
		<pre>
		&lt;add key=&quot;NeatUpload.MaxNormalRequestLength&quot; value=&quot;<em>sizeInKBytes</em>&quot; /&gt;
		</pre>
		</p>

		<h3>Customizing Progress.aspx</h3>
		<p>
		The Progress.aspx page that comes with NeatUpload is just an example.  You should modify it to suit your needs.
		For example, you could change the color scheme with minor modification to the default.css stylesheet that is 
		included, or you could change the text or images that are used by modifying Progress.aspx itself.  You could even
		rearrange the layout entirely.  The only restriction is that you must continue to include elements with the 
		following id attributes and tag names, each with the runat attribute set to "server":
		</p>
		<table>
			<thead><td><strong>ID</strong></td><td><strong>Tag Name</strong></td></thead>
			<tr><td>barDiv</td><td>any</td></tr>
			<tr><td>statusDiv</td><td>any</td></tr>
			<tr><td>inProgressSpan</td><td>any</td></tr>
			<tr><td>remainingTimeSpan</td><td>any</td></tr>
			<tr><td>completedSpan</td><td>any</td></tr>
			<tr><td>cancelledSpan</td><td>any</td></tr>
			<tr><td>refreshLink</td><td>A</td></tr>
			<tr><td>stopRefreshLink</td><td>A</td></tr>
			<tr><td>cancelLink</td><td>A</td></tr>
		</table>
		<p>
		Refer to the sample Progress.aspx to see how each of these elements is used.  Note that the codebehind will 
		hide the above link elements (and their contents) when appropriate.  For example, the refreshLink and 
		stopRefreshLink elements are hidden whenever Javascript is available because they are used to manually start
		and stop refreshing the progress display.
		</p>
		
		<h3>Creating Custom Fallback Content for ProgressBar</h3>
		<p>
		If Javascript is not available or the browser doesn't support iframes and the ProgressBar element is
		empty, a "Check Upload Progress" link will be displayed.  To change the text of that link, simply place the 
		desired text (or controls) between the begin and end tags of the ProgressBar element.  For example:
		<pre>
			&lt;Upload:ProgressBar id=&quot;progressBar&quot; runat=&quot;server&quot; &gt;
				&lt;asp:Label id=&quot;label&quot; runat=&quot;server&quot; Text=&quot;Your Text Here&quot;/&gt;
			&lt;/Upload:ProgressBar&gt;
		</pre>
		</p>
	</Body>
</Html>